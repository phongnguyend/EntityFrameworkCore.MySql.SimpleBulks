using EntityFrameworkCore.MySql.SimpleBulks.Extensions;
using MySqlConnector;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Linq.Expressions;

namespace EntityFrameworkCore.MySql.SimpleBulks;

public class MySqlTableInforBuilder<T>
{
    private string _name;

    private IReadOnlyList<string> _primaryKeys;

    private List<string> _propertyNames;

    private List<string> _insertablePropertyNames;

    private Dictionary<string, string> _columnNameMappings = new();

    private Dictionary<string, string> _columnTypeMappings = new();

    private Dictionary<string, ValueConverter> _valueConverters = new();

    private OutputId _outputId;

    private Func<T, string, string, MySqlParameter> _parameterConverter;

    private Discriminator _discriminator;

    public MySqlTableInforBuilder()
    {
        _propertyNames = PropertiesCache<T>.GetProperties().Select(x => x.Key).ToList();
        _insertablePropertyNames = PropertiesCache<T>.GetProperties().Select(x => x.Key).ToList();
    }

    public MySqlTableInforBuilder<T> TableName(string name)
    {
        _name = name;
        return this;
    }

    public MySqlTableInforBuilder<T> PrimaryKeys(IReadOnlyList<string> primaryKeys)
    {
        _primaryKeys = primaryKeys;
        return this;
    }

    public MySqlTableInforBuilder<T> PrimaryKeys(Expression<Func<T, object>> primaryKeysSelector)
    {
        var primaryKey = primaryKeysSelector.Body.GetMemberName();
        var primaryKeys = string.IsNullOrEmpty(primaryKey) ? primaryKeysSelector.Body.GetMemberNames() : [primaryKey];
        return PrimaryKeys(primaryKeys);
    }

    public MySqlTableInforBuilder<T> OutputId(string name, OutputIdMode outputIdMode)
    {
        _outputId = new OutputId
        {
            Name = name,
            Mode = outputIdMode
        };
        return this;
    }

    public MySqlTableInforBuilder<T> OutputId(Expression<Func<T, object>> nameSelector, OutputIdMode outputIdMode)
    {
        var propertyName = nameSelector.Body.GetMemberName();
        return OutputId(propertyName, outputIdMode);
    }

    public MySqlTableInforBuilder<T> ParameterConverter(Func<T, string, string, MySqlParameter> converter)
    {
        _parameterConverter = converter;
        return this;
    }

    public MySqlTableInforBuilder<T> IgnoreProperty(string name)
    {
        if (_propertyNames != null && _propertyNames.Contains(name))
        {
            _propertyNames.Remove(name);
        }

        if (_insertablePropertyNames != null && _insertablePropertyNames.Contains(name))
        {
            _insertablePropertyNames.Remove(name);
        }

        return this;
    }

    public MySqlTableInforBuilder<T> IgnoreProperty(Expression<Func<T, object>> nameSelector)
    {
        var propertyName = nameSelector.Body.GetMemberName();

        return IgnoreProperty(propertyName);
    }

    public MySqlTableInforBuilder<T> ConfigureProperty(string propertyName, string columnName = null, string columnType = null, bool? readOnly = null)
    {
        if (columnName != null)
        {
            _columnNameMappings[propertyName] = columnName;
        }

        if (columnType != null)
        {
            _columnTypeMappings[propertyName] = columnType;
        }

        if (readOnly == true && _insertablePropertyNames != null && _insertablePropertyNames.Contains(propertyName))
        {
            _insertablePropertyNames.Remove(propertyName);
        }

        return this;
    }

    public MySqlTableInforBuilder<T> ConfigureProperty(Expression<Func<T, object>> nameSelector, string columnName = null, string columnType = null, bool? readOnly = null)
    {
        var propertyName = nameSelector.Body.GetMemberName();

        return ConfigureProperty(propertyName, columnName, columnType, readOnly);
    }

    public MySqlTableInforBuilder<T> ConfigureComplexProperty(string propertyName)
    {
        IgnoreProperty(propertyName);

        var prefix = propertyName + ".";

        var properties = PropertiesCache<T>.GetProperty(propertyName)?.PropertyType.GetProperties();
        var propertyNames = properties?.Select(p => prefix + p.Name).ToList();

        foreach (var property in propertyNames)
        {
            if (_columnNameMappings.ContainsKey(property))
                continue;

            _columnNameMappings[property] = property.Replace(".", "_");
        }

        _propertyNames.AddRange(propertyNames);
        _insertablePropertyNames.AddRange(propertyNames);

        return this;
    }

    public MySqlTableInforBuilder<T> ConfigureComplexProperty(Expression<Func<T, object>> nameSelector)
    {
        var propertyName = nameSelector.Body.GetMemberName();

        return ConfigureComplexProperty(propertyName);
    }

    public MySqlTableInforBuilder<T> ConfigurePropertyConversion<TProperty, TProvider>(Expression<Func<T, TProperty>> nameSelector, Func<TProperty, TProvider?> convertToProvider, Func<TProvider?, TProperty?> convertFromProvider)
    {
        var propertyName = nameSelector.Body.GetMemberName();
        _valueConverters[propertyName] = new ValueConverter
        {
            ProviderClrType = typeof(TProvider),
            ConvertToProvider = obj => convertToProvider((TProperty?)obj),
            ConvertFromProvider = obj => convertFromProvider((TProvider?)obj),
        };
        return this;
    }

    public MySqlTableInforBuilder<T> ConfigureDiscriminator(string propertyName, object value, string columnName = null, string columnType = null)
    {
        _discriminator = new Discriminator
        {
            PropertyName = propertyName,
            PropertyType = value.GetType(),
            PropertyValue = value,
            ColumnName = columnName,
            ColumnType = columnType,
        };

        if (columnName != null)
        {
            _columnNameMappings[propertyName] = columnName;
        }

        if (columnType != null)
        {
            _columnTypeMappings[propertyName] = columnType;
        }

        return this;
    }

    public MySqlTableInforBuilder<T> ConfigureDiscriminator<TProperty>(Expression<Func<T, TProperty>> nameSelector, TProperty value, string columnName = null, string columnType = null)
    {
        var propertyName = nameSelector.Body.GetMemberName();
        return ConfigureDiscriminator(propertyName, value, columnName, columnType);
    }

    public MySqlTableInfor<T> Build()
    {
        if (_outputId?.Mode == OutputIdMode.ServerGenerated && _insertablePropertyNames.Contains(_outputId.Name))
        {
            _insertablePropertyNames.Remove(_outputId.Name);
        }

        var tableInfor = new MySqlTableInfor<T>(_name)
        {
            PrimaryKeys = _primaryKeys,
            PropertyNames = _propertyNames,
            InsertablePropertyNames = _insertablePropertyNames,
            ColumnNameMappings = _columnNameMappings,
            ColumnTypeMappings = _columnTypeMappings,
            ValueConverters = _valueConverters,
            OutputId = _outputId,
            ParameterConverter = _parameterConverter,
            Discriminator = _discriminator
        };
        return tableInfor;
    }
}
